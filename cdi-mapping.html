<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CDI MAPPING</title>

  <!-- ===== PWA (HANYA CDI) ===== -->
  <link rel="manifest" href="/cdi.webmanifest">
  <meta name="theme-color" content="#0e0f13">

  <!-- iOS "Add to Home Screen" -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="CDI Map">
  <link rel="apple-touch-icon" href="/assets/icon-192.png">

  <!-- pakai style.css kamu -->
  <link rel="stylesheet" href="cdi/css/style.css" />

  <!-- ===== ROTATE CSS (dibuat di TOPBAR, bukan fixed) ===== -->
  <style>
    /* bungkus kanan atas untuk tombol-tombol */
    .top-actions{
      display:flex;
      align-items:center;
      gap:10px;
    }

    /* tombol kecil gaya sama (rotate/install/menu) */
    .ui-btn{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.45);
      color:#fff;
      font-weight:700;
      letter-spacing:.04em;
      font-size:12px;
      cursor:pointer;
      backdrop-filter: blur(8px);
      line-height:1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .ui-btn:active{ transform:scale(.98); }

    /* pastikan dropdown menu tampil di atas tombol */
    .menu-wrapper{ position:relative; }
    .menu-dropdown{ z-index:99999; }

    /* root normal */
    #appRoot{ min-height:100vh; }

    /* mode rotate */
    body.rotate-mode{ overflow:hidden; }

    body.rotate-mode #appRoot{
      position:fixed;
      top:0;
      left:0;

      width:100vh;
      height:100vw;

      transform-origin: top left;
      transform: rotate(90deg) translateY(-100%) scale(1.08);
    }
  </style>
</head>

<body>

<!-- ===== SEMUA KONTEN CDI DI DALAM ROOT (BIAR BISA DIPUTAR) ===== -->
<div id="appRoot">

  <header class="topbar">
    <div class="title">CDI MAPPING</div>

    <!-- kanan atas: ROTATE + (opsional INSTALL) + MENU -->
    <div class="top-actions">

      <!-- ROTATE (tidak menutupi menu karena sejajar di topbar) -->
      <button id="rotateBtn" class="ui-btn" type="button" aria-label="Rotate">
        ⟳ ROTATE
      </button>

      <!-- INSTALL (muncul otomatis kalau PWA memenuhi syarat) -->
      <button id="installBtn" class="ui-btn" type="button" style="display:none;" aria-label="Install">
        ⬇ INSTALL
      </button>

      <!-- MENU ☰ (hanya CDI) -->
      <div class="menu-wrapper">
        <button class="ui-btn" type="button" onclick="toggleMenu()" aria-label="Menu">☰</button>

        <div id="menuDropdown" class="menu-dropdown hidden">
          <div onclick="selectCDI('basic')">CDI POWER BAND A1</div>
          <div onclick="selectCDI('dual')">CDI POWER SMT A2</div>
          <div onclick="selectCDI('racing')">CDI POWER SMT A3</div>
        </div>
      </div>

    </div>
  </header>

  <div class="bg-image"></div>

  <!-- area render map -->
  <div id="contentArea" class="content empty">
    <div class="empty-text">Pilih tipe CDI melalui menu ☰</div>
  </div>

</div><!-- /#appRoot -->

<script src="cdi/js/app.js"></script>

<!-- =========================
     MODUL CDI (NON-MODULE)
========================= -->
<script src="cdi/js/esp/esp-api.js"></script>
<script src="cdi/js/esp/esp-api-dual.js"></script>
<script src="cdi/js/cdi-basic/cdi-basic.js"></script>
<script src="cdi/js/cdi-basic/cdi-basic-live.js"></script>
<script src="cdi/js/cdi-dual/cdi-dual.js"></script>
<script src="cdi/js/cdi-dual/cdi-dual-live.js"></script>
<script src="cdi/js/cdi-racing/cdi-racing.js"></script>

<!-- ===== ROTATE JS ===== -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('rotateBtn');

  // restore state
  const saved = localStorage.getItem('rotate_mode_cdi') === '1';
  if (saved) document.body.classList.add('rotate-mode');

  if (btn){
    btn.addEventListener('click', () => {
      document.body.classList.toggle('rotate-mode');
      localStorage.setItem(
        'rotate_mode_cdi',
        document.body.classList.contains('rotate-mode') ? '1' : '0'
      );
    });
  }
});
</script>

<!-- ===== SERVICE WORKER REGISTER ===== -->
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/service-worker.js").catch(()=>{});
}
</script>

<!-- ===== INSTALL BUTTON (PROMPT) ===== -->
<script>
let deferredPrompt = null;

window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;
  const btn = document.getElementById("installBtn");
  if (btn) btn.style.display = "inline-flex";
});

window.addEventListener("appinstalled", () => {
  deferredPrompt = null;
  const btn = document.getElementById("installBtn");
  if (btn) btn.style.display = "none";
});

document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("installBtn");
  if (!btn) return;

  btn.addEventListener("click", async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt = null;
    btn.style.display = "none";
  });
});
</script>

</body>
</html>
