<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>CDI MAPPING</title>

  <!-- ===== PWA (HANYA CDI) ===== -->
  <link rel="manifest" href="/cdi.webmanifest">
  <meta name="theme-color" content="#0e0f13">

  <!-- iOS "Add to Home Screen" -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="CDI Map">
  <link rel="apple-touch-icon" href="/assets/icon-192.png">

  <!-- style utama -->
  <link rel="stylesheet" href="cdi/css/style.css" />

  <style>
    :root{
      --rot-base: 1;     /* dihitung via JS */
      --ui-zoom:  1;     /* slider zoom */
    }

    /* ===== topbar sejajar ===== */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .top-actions{
      display:flex;
      align-items:center;
      gap:10px;
      margin-left:auto;
    }

    /* tombol chip kecil (ROTATE/INSTALL) */
    .chip-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      height:36px;
      padding:0 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.35);
      color:#fff;
      font-weight:700;
      letter-spacing:.04em;
      font-size:12px;
      cursor:pointer;
      backdrop-filter: blur(8px);
      -webkit-tap-highlight-color: transparent;
      user-select:none;
      white-space:nowrap;
    }
    .chip-btn:active{ transform:scale(.98); }

    /* tombol ‚ò∞ */
    .menu-wrapper{ position:relative; }
    .menu-wrapper .menu-btn{
      height:36px;
      width:44px;
      padding:0;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.35);
      color:#fff;
      font-size:18px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }

    /* dropdown tetap aman */
    .menu-dropdown{
      top:44px !important;
      right:0 !important;
      z-index:999999;
    }

    /* ===== ROTATE STAGE ===== */
    #rotateStage{ min-height:100vh; }

    /* Normal */
    #appRoot{
      min-height:100vh;
      position:relative;
    }

    /* Rotate: kita putar appRoot di tengah layar dan pakai base-scale agar tidak ‚Äúkebablasan‚Äù */
    body.rotate-mode{
      overflow:hidden;
    }

    body.rotate-mode #rotateStage{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#0e0f13;
      overflow:hidden;
    }

    body.rotate-mode #appRoot{
      width:100vw;
      height:100vh;
      transform-origin:center;
      transform: rotate(90deg) scale(calc(var(--rot-base) * var(--ui-zoom)));
      overflow:hidden;
    }

    /* ===== ZOOM DOCK (tab kecil bawah & ikut rotasi karena ada di dalam appRoot) ===== */
    .zoom-dock{
      position:absolute;
      left:50%;
      bottom:10px;
      transform:translateX(-50%);
      z-index:999998;
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.40);
      backdrop-filter: blur(10px);
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }

    .zoom-dock .zbtn{
      height:34px;
      min-width:40px;
      padding:0 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.35);
      color:#fff;
      font-weight:800;
      cursor:pointer;
    }
    .zoom-dock .zbtn:active{ transform:scale(.98); }

    .zoom-dock .zrange{
      width:140px;
      accent-color:#ffffff;
    }

    .zoom-dock .lock{
      height:34px;
      padding:0 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.35);
      color:#fff;
      font-weight:800;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .zoom-dock .lock.on{
      border-color: rgba(255,255,255,.35);
      background: rgba(0,0,0,.55);
    }

    /* ===== TOOLTIP kanan & bawah ===== */
    .hint{
      position:absolute;
      z-index:999997;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.35);
      color:#fff;
      font-size:12px;
      letter-spacing:.02em;
      backdrop-filter: blur(10px);
      opacity:0;
      transform: translateY(4px);
      transition: .25s ease;
      pointer-events:none;
    }
    .hint.show{ opacity:1; transform: translateY(0); }

    .hint-right{ right:10px; top:50%; transform:translateY(-50%); }
    .hint-bottom{ left:50%; bottom:58px; transform:translateX(-50%); }

    /* ===== LOCK: cegah halaman geser waktu edit kurva ===== */
    body.ui-lock, body.ui-lock html{
      overscroll-behavior: none;
    }

    /* kecilin untuk HP sempit */
    @media (max-width:420px){
      .chip-btn{ padding:0 10px; font-size:11px; height:34px; }
      .menu-wrapper .menu-btn{ height:34px; width:40px; }
      .zoom-dock .zrange{ width:110px; }
    }
  </style>
</head>

<body>

<div id="rotateStage">
  <div id="appRoot">

    <header class="topbar">
      <div class="title">CDI MAPPING</div>

      <!-- KANAN: ROTATE + INSTALL + ‚ò∞ -->
      <div class="top-actions">

        <button id="rotateBtn" class="chip-btn" type="button" aria-label="Rotate">
          ‚ü≥ ROTATE
        </button>

        <button id="installBtn" class="chip-btn" type="button" aria-label="Install" style="display:none;">
          ‚¨á INSTALL
        </button>

        <div class="menu-wrapper">
          <button class="menu-btn" type="button" onclick="toggleMenu()" aria-label="Menu">‚ò∞</button>
          <div id="menuDropdown" class="menu-dropdown hidden">
            <div onclick="selectCDI('basic')">CDI POWER BAND A1</div>
            <div onclick="selectCDI('dual')">CDI POWER SMT A2</div>
            <div onclick="selectCDI('racing')">CDI POWER SMT A3</div>
          </div>
        </div>

      </div>
    </header>

    <div class="bg-image"></div>

    <div id="contentArea" class="content empty">
      <div class="empty-text">Pilih tipe CDI melalui menu ‚ò∞</div>
    </div>

    <!-- ===== TOOLTIP ===== -->
    <div id="hintRight" class="hint hint-right">Geser layar: tarik area map</div>
    <div id="hintBottom" class="hint hint-bottom">Zoom: pakai tab bawah (biar layar tidak lari)</div>

    <!-- ===== ZOOM DOCK (bawah) ===== -->
    <div class="zoom-dock" id="zoomDock" aria-label="Zoom Dock">
      <button class="zbtn" id="zoomOutBtn" type="button">‚àí</button>
      <input class="zrange" id="zoomRange" type="range" min="80" max="140" value="100">
      <button class="zbtn" id="zoomInBtn" type="button">+</button>
      <button class="lock on" id="lockBtn" type="button" title="Kunci layar agar tidak scroll">
        üîí LOCK
      </button>
    </div>

  </div>
</div>

<!-- app utama -->
<script src="cdi/js/app.js"></script>

<!-- modul CDI -->
<script src="cdi/js/esp/esp-api.js"></script>
<script src="cdi/js/esp/esp-api-dual.js"></script>
<script src="cdi/js/cdi-basic/cdi-basic.js"></script>
<script src="cdi/js/cdi-basic/cdi-basic-live.js"></script>
<script src="cdi/js/cdi-dual/cdi-dual.js"></script>
<script src="cdi/js/cdi-dual/cdi-dual-live.js"></script>
<script src="cdi/js/cdi-racing/cdi-racing.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  /* ========= HITUNG BASE SCALE ROTATE (biar tidak kebablasan dan tombol ‚ò∞ tetap kelihatan) ========= */
  function updateRotateBase(){
    const w = window.innerWidth;
    const h = window.innerHeight;
    const base = (w < h) ? (w / h) : 1; // portrait: shrink secukupnya
    document.documentElement.style.setProperty('--rot-base', base.toFixed(4));
  }
  updateRotateBase();
  window.addEventListener('resize', updateRotateBase);

  /* ========= ROTATE (PAKAI sessionStorage -> tutup app balik normal) ========= */
  const rotateBtn = document.getElementById('rotateBtn');

  // restore hanya selama sesi (bukan permanen)
  const savedRotate = sessionStorage.getItem('rotate_mode_cdi') === '1';
  if (savedRotate) document.body.classList.add('rotate-mode');

  rotateBtn.addEventListener('click', () => {
    document.body.classList.toggle('rotate-mode');
    sessionStorage.setItem('rotate_mode_cdi',
      document.body.classList.contains('rotate-mode') ? '1' : '0'
    );
    // tampilkan hint sebentar setiap kali rotate
    showHints();
  });

  /* ========= ZOOM DOCK (ZOOM hanya mengubah scale rotate-mode) ========= */
  const zoomRange = document.getElementById('zoomRange');
  const zoomInBtn = document.getElementById('zoomInBtn');
  const zoomOutBtn = document.getElementById('zoomOutBtn');

  function setZoomFromPercent(pct){
    const z = Math.max(0.80, Math.min(1.40, pct / 100));
    document.documentElement.style.setProperty('--ui-zoom', z.toFixed(3));
    sessionStorage.setItem('zoom_cdi_pct', String(Math.round(z * 100)));
    zoomRange.value = String(Math.round(z * 100));
  }

  const savedZoom = parseInt(sessionStorage.getItem('zoom_cdi_pct') || '100', 10);
  setZoomFromPercent(isNaN(savedZoom) ? 100 : savedZoom);

  zoomRange.addEventListener('input', () => setZoomFromPercent(parseInt(zoomRange.value,10) || 100));
  zoomInBtn.addEventListener('click', () => setZoomFromPercent((parseInt(zoomRange.value,10) || 100) + 5));
  zoomOutBtn.addEventListener('click', () => setZoomFromPercent((parseInt(zoomRange.value,10) || 100) - 5));

  /* ========= LOCK (biar edit titik kurva tidak ‚Äúscroll layar‚Äù) ========= */
  const lockBtn = document.getElementById('lockBtn');
  let lockOn = true;

  function applyLock(){
    document.body.classList.toggle('ui-lock', lockOn);
    lockBtn.classList.toggle('on', lockOn);
    lockBtn.innerHTML = lockOn ? 'üîí LOCK' : 'üîì UNLOCK';
  }
  applyLock();

  lockBtn.addEventListener('click', () => {
    lockOn = !lockOn;
    applyLock();
  });

  // cegah scroll/pull-to-refresh saat lock ON (kecuali kalau sentuh slider zoom / menu)
  function isAllowedTarget(t){
    return !!(t.closest && (
      t.closest('#zoomDock') ||
      t.closest('#menuDropdown') ||
      t.closest('.menu-wrapper')
    ));
  }

  document.addEventListener('touchmove', (e) => {
    if (!lockOn) return;
    if (isAllowedTarget(e.target)) return;
    // cegah halaman geser
    e.preventDefault();
  }, { passive:false });

  /* ========= TOOLTIP kanan & bawah ========= */
  const hintRight = document.getElementById('hintRight');
  const hintBottom = document.getElementById('hintBottom');
  let hintTimer = null;

  function showHints(){
    clearTimeout(hintTimer);
    hintRight.classList.add('show');
    hintBottom.classList.add('show');
    hintTimer = setTimeout(() => {
      hintRight.classList.remove('show');
      hintBottom.classList.remove('show');
    }, 3500);
  }
  // tampil sekali saat pertama load
  showHints();

  /* ========= INSTALL (PWA) ========= */
  const installBtn = document.getElementById('installBtn');
  let deferredPrompt = null;

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.style.display = 'inline-flex';
  });

  installBtn.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt = null;
    installBtn.style.display = 'none';
  });

  window.addEventListener('appinstalled', () => {
    installBtn.style.display = 'none';
  });

  /* ========= SERVICE WORKER ========= */
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/service-worker.js").catch(()=>{});
  }
});
</script>

</body>
</html>
