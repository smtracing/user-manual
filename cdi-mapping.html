<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>CDI MAPPING</title>

  <!-- ===== PWA (HANYA CDI) ===== -->
  <link rel="manifest" href="/cdi.webmanifest">
  <meta name="theme-color" content="#0e0f13">

  <!-- iOS "Add to Home Screen" -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="CDI Map">
  <link rel="apple-touch-icon" href="/assets/icon-192.png">

  <!-- style utama -->
  <link rel="stylesheet" href="cdi/css/style.css" />

  <style>
    /* ===== TOPBAR BUTTONS (sejajar) ===== */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .top-actions{
      display:flex;
      align-items:center;
      gap:10px;
      margin-left:auto;
      flex:0 0 auto;
    }

    .chip-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      height:36px;
      padding:0 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.35);
      color:#fff;
      font-weight:700;
      letter-spacing:.04em;
      font-size:12px;
      cursor:pointer;
      backdrop-filter: blur(8px);
      -webkit-tap-highlight-color: transparent;
      user-select:none;
      white-space:nowrap;
    }
    .chip-btn:active{ transform:scale(.98); }

    .menu-wrapper{ position:relative; }
    .menu-wrapper .menu-btn{
      height:36px;
      width:44px;
      padding:0;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.35);
      color:#fff;
      font-size:18px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .menu-dropdown{
      top:44px !important;
      right:0 !important;
      z-index:99999;
    }

    @media (max-width:420px){
      .chip-btn{ padding:0 10px; font-size:11px; height:34px; }
      .menu-wrapper .menu-btn{ height:34px; width:40px; }
    }

    /* ===== ROTATE MODE (ANDROID/PWA AMAN) ===== */
    :root{
      --vw: 100vw; /* akan di-update JS supaya presisi */
      --vh: 100vh;
    }

    #appRoot{ min-height:100vh; }

    body.rotate-mode{
      overflow:hidden;
      height:100%;
    }

    body.rotate-mode #appRoot{
      position:fixed;
      top:0;
      left:0;

      /* swap ukuran pakai variabel viewport */
      width: var(--vh);
      height: var(--vw);

      transform-origin: top left;

      /* PENTING: pakai -100vw, bukan -100% */
      transform: rotate(90deg) translateY(calc(-1 * var(--vw)));
    }

    /* bg-image di rotate-mode jangan fixed (sering bikin "hilang") */
    body.rotate-mode .bg-image{
      position:absolute !important;
      inset:0 !important;
    }
  </style>
</head>

<body>

<div id="appRoot">

  <header class="topbar">
    <div class="title">CDI MAPPING</div>

    <div class="top-actions">

      <button id="rotateBtn" class="chip-btn" type="button" aria-label="Rotate">
        ⟳ ROTATE
      </button>

      <button id="installBtn" class="chip-btn" type="button" aria-label="Install" style="display:none;">
        ⬇ INSTALL
      </button>

      <div class="menu-wrapper">
        <button class="menu-btn" type="button" onclick="toggleMenu()" aria-label="Menu">☰</button>

        <div id="menuDropdown" class="menu-dropdown hidden">
          <div onclick="selectCDI('basic')">CDI POWER BAND A1</div>
          <div onclick="selectCDI('dual')">CDI POWER SMT A2</div>
          <div onclick="selectCDI('racing')">CDI POWER SMT A3</div>
        </div>
      </div>

    </div>
  </header>

  <div class="bg-image"></div>

  <div id="contentArea" class="content empty">
    <div class="empty-text">Pilih tipe CDI melalui menu ☰</div>
  </div>

</div>

<!-- app utama -->
<script src="cdi/js/app.js"></script>

<!-- modul CDI -->
<script src="cdi/js/esp/esp-api.js"></script>
<script src="cdi/js/esp/esp-api-dual.js"></script>
<script src="cdi/js/cdi-basic/cdi-basic.js"></script>
<script src="cdi/js/cdi-basic/cdi-basic-live.js"></script>
<script src="cdi/js/cdi-dual/cdi-dual.js"></script>
<script src="cdi/js/cdi-dual/cdi-dual-live.js"></script>
<script src="cdi/js/cdi-racing/cdi-racing.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {

  /* ===== viewport vars (biar rotate pas, tidak "kebablasan") ===== */
  function setViewportVars(){
    // innerWidth/innerHeight biasanya lebih akurat di Android/PWA
    document.documentElement.style.setProperty('--vw', window.innerWidth + 'px');
    document.documentElement.style.setProperty('--vh', window.innerHeight + 'px');
  }
  setViewportVars();
  window.addEventListener('resize', setViewportVars);
  window.addEventListener('orientationchange', () => setTimeout(setViewportVars, 200));

  /* ===== ROTATE (SESSION ONLY: hilang saat app ditutup) ===== */
  const rotateBtn = document.getElementById('rotateBtn');
  const saved = sessionStorage.getItem('rotate_mode_cdi') === '1';
  if (saved) document.body.classList.add('rotate-mode');
  else document.body.classList.remove('rotate-mode');

  rotateBtn.addEventListener('click', () => {
    const on = document.body.classList.toggle('rotate-mode');
    sessionStorage.setItem('rotate_mode_cdi', on ? '1' : '0');
    // update var setelah mode berubah (biar pas)
    setTimeout(setViewportVars, 50);
  });

  /* ===== INSTALL (PWA) ===== */
  const installBtn = document.getElementById('installBtn');
  let deferredPrompt = null;

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.style.display = 'inline-flex';
  });

  installBtn.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt = null;
    installBtn.style.display = 'none';
  });

  window.addEventListener('appinstalled', () => {
    installBtn.style.display = 'none';
  });

  /* ===== SERVICE WORKER REGISTER ===== */
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/service-worker.js").catch(()=>{});
  }
});
</script>

</body>
</html>
