
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>CDI MAPPING</title>

  <!-- ===== PWA (HANYA CDI) ===== -->
  <link rel="manifest" href="/cdi.webmanifest">
  <meta name="theme-color" content="#0e0f13">

  <!-- iOS "Add to Home Screen" -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="CDI Map">
  <link rel="apple-touch-icon" href="/assets/icon-192.png">

  <!-- style utama -->
  <link rel="stylesheet" href="cdi/css/style.css" />

  <style>
    :root{
      --topbar-h: 56px;
      --dock-h: 56px;
      --dock-h-rot: 44px;
      --ui-zoom: 1;

      --safeT: env(safe-area-inset-top);
      --safeB: env(safe-area-inset-bottom);
      --safeL: env(safe-area-inset-left);
      --safeR: env(safe-area-inset-right);
    }

    html, body{
      height:100%;
      overflow:hidden;
      overscroll-behavior:none;
      background:#0e0f13;
    }

    /* ===== topbar rapih ===== */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      height:var(--topbar-h);
      padding-left: calc(12px + var(--safeL));
      padding-right: calc(12px + var(--safeR));
    }
    .top-actions{
      display:flex;
      align-items:center;
      gap:10px;
      margin-left:auto;
    }

    .chip-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      height:36px;
      padding:0 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.35);
      color:#fff;
      font-weight:700;
      letter-spacing:.04em;
      font-size:12px;
      cursor:pointer;
      backdrop-filter: blur(8px);
      -webkit-tap-highlight-color: transparent;
      user-select:none;
      white-space:nowrap;
    }
    .chip-btn:active{ transform:scale(.98); }

    .menu-wrapper{ position:relative; }
    .menu-wrapper .menu-btn{
      height:36px;
      width:44px;
      padding:0;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.35);
      color:#fff;
      font-size:18px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .menu-dropdown{
      top:44px !important;
      right:0 !important;
      z-index:999999;
    }

    /* ===== ROOT NORMAL ===== */
    #appRoot{
      height:100vh;
      width:100vw;
      position:relative;
      overflow:hidden;
    }

    /* ===== ROTATE MODE (pas, tidak geser kiri) ===== */
    body.rotate-mode{ overflow:hidden; }
    body.rotate-mode #appRoot{
      position:fixed;
      top:0;
      left:0;
      width:100vh;
      height:100vw;
      transform-origin: top left;
      transform: rotate(90deg) translateY(-100%);
    }

    /* ===== WORKSPACE 1 layar ===== */
    #workspace{
      position:absolute;
      top:var(--topbar-h);
      left:0;
      right:0;
      bottom:var(--dock-h);
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      overscroll-behavior:contain;
      padding-bottom: calc(6px + var(--safeB));
    }
    body.rotate-mode #workspace{ bottom:var(--dock-h-rot); }

    #workspace::-webkit-scrollbar{ display:none; }

    /* area yang di-zoom */
    #workspaceInner{
      transform-origin: top left;
      transform: scale(var(--ui-zoom));
      width: calc(100% / var(--ui-zoom));
      min-height: calc(100% / var(--ui-zoom));
    }

    /* background */
    .bg-image{ position:fixed; inset:0; }

    /* ===== DOCK ZOOM bawah ===== */
    .zoom-dock{
      position:absolute;
      left:50%;
      bottom: calc(10px + var(--safeB));
      transform:translateX(-50%);
      z-index:999998;
      height:46px;
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.40);
      backdrop-filter: blur(10px);
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .zoom-dock .zbtn{
      height:34px;
      min-width:40px;
      padding:0 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.35);
      color:#fff;
      font-weight:900;
      cursor:pointer;
    }
    .zoom-dock .zbtn:active{ transform:scale(.98); }
    .zoom-dock .zrange{ width:140px; accent-color:#ffffff; }
    .zoom-dock .zlabel{
      font-size:12px;
      color:#fff;
      opacity:.85;
      min-width:44px;
      text-align:right;
    }

    /* rotate: dock kecil + pindah kiri bawah (biar mapping lega) */
    body.rotate-mode .zoom-dock{
      left: calc(12px + var(--safeL));
      bottom: calc(10px + var(--safeB));
      transform:none;
      height:38px;
      padding:6px 8px;
      border-radius:12px;
      gap:8px;
    }
    body.rotate-mode .zoom-dock .zbtn{
      height:28px;
      min-width:34px;
      padding:0 8px;
      border-radius:10px;
    }
    body.rotate-mode .zoom-dock .zrange{ width:90px; }
    body.rotate-mode .zoom-dock .zlabel{ min-width:38px; font-size:11px; }

    /* ===== TOOLTIP fixed ===== */
    .hint{
      position:fixed;
      z-index:999997;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.35);
      color:#fff;
      font-size:12px;
      backdrop-filter: blur(10px);
      opacity:0;
      transform: translateY(4px);
      transition: .25s ease;
      pointer-events:none;
    }
    .hint.show{ opacity:1; transform: translateY(0); }
    .hint-right{
      right: calc(10px + var(--safeR));
      top:50%;
      transform:translateY(-50%);
    }
    .hint-bottom{
      left:50%;
      bottom:calc(var(--dock-h) + 12px + var(--safeB));
      transform:translateX(-50%);
    }
    body.rotate-mode .hint-bottom{
      bottom:calc(var(--dock-h-rot) + 12px + var(--safeB));
    }

    @media (max-width:420px){
      :root{ --dock-h: 60px; }
      .chip-btn{ padding:0 10px; font-size:11px; height:34px; }
      .menu-wrapper .menu-btn{ height:34px; width:40px; }
      .zoom-dock .zrange{ width:110px; }
      .zoom-dock .zlabel{ min-width:40px; }
    }

    /* ============================
       FIX HP: grafis bisa “drag titik”
       - matikan scroll di area canvas/plot
       - aktifkan touch/pointer yang tepat
    ============================ */
    #contentArea canvas,
    #contentArea svg,
    #contentArea .plot,
    #contentArea .graph{
      touch-action: none;         /* penting: supaya finger drag tidak jadi scroll */
      -webkit-user-select: none;
      user-select: none;
    }
  </style>
</head>

<body>
<div id="appRoot">

  <header class="topbar">
    <div class="title">CDI MAPPING</div>

    <div class="top-actions">
      <button id="rotateBtn" class="chip-btn" type="button">⟳ ROTATE</button>
      <button id="installBtn" class="chip-btn" type="button" style="display:none;">⬇ INSTALL</button>

      <div class="menu-wrapper">
        <button class="menu-btn" type="button" onclick="toggleMenu()" aria-label="Menu">☰</button>
        <div id="menuDropdown" class="menu-dropdown hidden">
          <div onclick="selectCDI('basic')">CDI POWER BAND A1</div>
          <div onclick="selectCDI('dual')">CDI POWER SMT A2</div>
          <div onclick="selectCDI('racing')">CDI POWER SMT A3</div>
        </div>
      </div>
    </div>
  </header>

  <div class="bg-image"></div>

  <div id="hintRight" class="hint hint-right">Geser kiri/kanan: tarik di area map</div>
  <div id="hintBottom" class="hint hint-bottom">Zoom pakai tab bawah</div>

  <div id="workspace">
    <div id="workspaceInner">
      <div id="contentArea" class="content empty">
        <div class="empty-text">Pilih tipe CDI melalui menu ☰</div>
      </div>
    </div>
  </div>

  <div class="zoom-dock" id="zoomDock">
    <button class="zbtn" id="zoomOutBtn" type="button">−</button>
    <input class="zrange" id="zoomRange" type="range" min="80" max="160" value="100">
    <button class="zbtn" id="zoomInBtn" type="button">+</button>
    <div class="zlabel" id="zoomLabel">100%</div>
  </div>

</div>

<script src="cdi/js/app.js"></script>

<script src="cdi/js/esp/esp-api.js"></script>
<script src="cdi/js/esp/esp-api-dual.js"></script>
<script src="cdi/js/cdi-basic/cdi-basic.js"></script>
<script src="cdi/js/cdi-basic/cdi-basic-live.js"></script>
<script src="cdi/js/cdi-dual/cdi-dual.js"></script>
<script src="cdi/js/cdi-dual/cdi-dual-live.js"></script>
<script src="cdi/js/cdi-racing/cdi-racing.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {

  // ROTATE (tidak disimpan)
  document.getElementById('rotateBtn').addEventListener('click', () => {
    document.body.classList.toggle('rotate-mode');
    showHints();
  });

  // ZOOM UI (dock bawah)
  const zoomRange = document.getElementById('zoomRange');
  const zoomInBtn = document.getElementById('zoomInBtn');
  const zoomOutBtn = document.getElementById('zoomOutBtn');
  const zoomLabel = document.getElementById('zoomLabel');

  function setZoomPct(pct){
    const clamped = Math.max(80, Math.min(160, pct));
    const z = clamped / 100;
    document.documentElement.style.setProperty('--ui-zoom', z.toFixed(3));
    zoomRange.value = String(clamped);
    zoomLabel.textContent = clamped + "%";
  }
  setZoomPct(100);

  zoomRange.addEventListener('input', () => setZoomPct(parseInt(zoomRange.value,10) || 100));
  zoomInBtn.addEventListener('click', () => setZoomPct((parseInt(zoomRange.value,10) || 100) + 5));
  zoomOutBtn.addEventListener('click', () => setZoomPct((parseInt(zoomRange.value,10) || 100) - 5));

  // Tooltip
  const hintRight = document.getElementById('hintRight');
  const hintBottom = document.getElementById('hintBottom');
  let hintTimer = null;

  function showHints(){
    clearTimeout(hintTimer);
    hintRight.classList.add('show');
    hintBottom.classList.add('show');
    hintTimer = setTimeout(() => {
      hintRight.classList.remove('show');
      hintBottom.classList.remove('show');
    }, 3500);
  }
  showHints();

  // INSTALL (PWA)
  const installBtn = document.getElementById('installBtn');
  let deferredPrompt = null;

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.style.display = 'inline-flex';
  });

  installBtn.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt = null;
    installBtn.style.display = 'none';
  });

  window.addEventListener('appinstalled', () => {
    installBtn.style.display = 'none';
  });

  // SW
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/service-worker.js").catch(()=>{});
  }

  /* =========================================================
     FIX HP: titik kurva bisa diklik & drag (seperti PC)
     Masalah utama:
     1) kode map biasanya pakai mousedown/mousemove -> HP cuma touch
     2) UI zoom pakai CSS scale -> koordinat event jadi “melenceng”
     Solusi:
     - konversi touch/pointer -> mouse event
     - koreksi clientX/clientY sesuai --ui-zoom
     - matikan scroll workspace saat drag di canvas
  ========================================================= */
  const workspace = document.getElementById('workspace');
  const contentArea = document.getElementById('contentArea');

  function getUiZoom(){
    const v = getComputedStyle(document.documentElement).getPropertyValue('--ui-zoom').trim();
    const z = parseFloat(v);
    return (isFinite(z) && z > 0) ? z : 1;
  }

  // dispatch mouse event dengan koordinat yang sudah dikoreksi zoom
  function dispatchMouse(el, type, srcClientX, srcClientY, buttons=1){
    const rect = el.getBoundingClientRect();
    const zoom = getUiZoom();

    // koordinat “terlihat” (scaled) -> ubah ke “asli” (unscaled)
    const xScaled = srcClientX - rect.left;
    const yScaled = srcClientY - rect.top;

    const x = xScaled / zoom;
    const y = yScaled / zoom;

    const clientX = rect.left + x;
    const clientY = rect.top + y;

    const ev = new MouseEvent(type, {
      bubbles:true,
      cancelable:true,
      clientX, clientY,
      buttons,
      button:0
    });
    el.dispatchEvent(ev);
  }

  function attachToCanvas(canvas){
    if (!canvas || canvas.dataset.hpDragFix === "1") return;
    canvas.dataset.hpDragFix = "1";

    // penting supaya gesture tidak jadi scroll/zoom browser
    canvas.style.touchAction = "none";

    let active = false;
    let activeId = null;

    function lockScroll(lock){
      if (lock){
        // tahan scroll workspace saat finger drag titik
        workspace.style.overflow = "hidden";
      }else{
        workspace.style.overflow = "auto";
      }
    }

    // TOUCH (utama)
    canvas.addEventListener('touchstart', (e) => {
      if (!e.touches || e.touches.length !== 1) return;
      active = true;
      const t = e.touches[0];
      activeId = t.identifier;
      lockScroll(true);
      e.preventDefault();
      dispatchMouse(canvas, 'mousedown', t.clientX, t.clientY, 1);
    }, {passive:false});

    canvas.addEventListener('touchmove', (e) => {
      if (!active || !e.touches) return;
      const t = Array.from(e.touches).find(x => x.identifier === activeId) || e.touches[0];
      if (!t) return;
      e.preventDefault();
      dispatchMouse(canvas, 'mousemove', t.clientX, t.clientY, 1);
    }, {passive:false});

    function endTouch(e){
      if (!active) return;
      active = false;
      activeId = null;
      lockScroll(false);
      e.preventDefault();
      // gunakan changedTouches jika ada
      const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : null;
      if (t) dispatchMouse(canvas, 'mouseup', t.clientX, t.clientY, 0);
      else dispatchMouse(canvas, 'mouseup', 0, 0, 0);
    }
    canvas.addEventListener('touchend', endTouch, {passive:false});
    canvas.addEventListener('touchcancel', endTouch, {passive:false});

    // POINTER (cadangan)
    canvas.addEventListener('pointerdown', (e) => {
      // jika browser sudah handle pointer, pastikan tidak jadi scroll
      if (e.pointerType === 'touch'){
        e.preventDefault();
      }
    }, {passive:false});
  }

  function scanAndAttach(){
    // biasanya grafik dibuat pakai <canvas>. kalau ada beberapa canvas, semua dipasang.
    const canvases = contentArea.querySelectorAll('canvas');
    canvases.forEach(attachToCanvas);
  }

  // pertama kali
  scanAndAttach();

  // kalau user ganti tipe CDI, isi contentArea berubah -> attach lagi otomatis
  const mo = new MutationObserver(() => scanAndAttach());
  mo.observe(contentArea, {childList:true, subtree:true});
});
</script>

</body>
</html>
